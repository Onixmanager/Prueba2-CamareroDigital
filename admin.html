<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Administración</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --warning-color: #f1c40f;
      --danger-color: #e74c3c;
      --light-color: #ecf0f1;
      --text-color: #333;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --border-radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f5f5;
      color: var(--text-color);
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .admin-header {
      position: relative;
      text-align: center;
      padding: 2rem;
      background-color: var(--primary-color);
      color: white;
      border-radius: var(--border-radius);
      margin-bottom: 2rem;
    }

    .header-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: row;
      gap: 10px;
      align-items: center;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 15px;
      border: none;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    #deleteAllBtn {
      background: var(--warning-color);
    }

    #deleteAllBtn:hover {
      background: #d39e00;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .filter-btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      background-color: var(--light-color);
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .filter-btn.active {
      background-color: var(--primary-color);
      color: white;
    }

    .filters-select {
      display: none;
      width: 100%;
      padding: 12px;
      margin-bottom: 1rem;
      border: 2px solid var(--primary-color);
      border-radius: var(--border-radius);
      background: white;
      font-size: 1rem;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232c3e50'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 24px;
      cursor: pointer;
    }

    .orders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .order-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow);
      position: relative;
      transition: transform 0.3s ease;
    }

    .order-status {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 15px;
      border-radius: var(--border-radius);
      font-size: 0.8rem;
      font-weight: bold;
    }

    .status-pending {
      background-color: var(--warning-color);
      color: var(--text-color);
    }

    .status-completed {
      background-color: var(--success-color);
      color: white;
    }

    .status-cancelled {
      background-color: var(--danger-color);
      color: white;
    }

    .order-table {
      font-size: 1.5rem;
      color: var(--primary-color);
      margin-bottom: 10px;
    }

    .order-time {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 15px;
    }

    .order-items {
      list-style: none;
      margin-bottom: 15px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .order-notes {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: var(--border-radius);
      margin-top: 10px;
      font-size: 0.9rem;
    }

    .order-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    .action-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: opacity 0.3s;
      font-size: 0.9rem;
    }

    .complete-btn {
      background-color: var(--success-color);
      color: white;
    }

    .cancel-btn {
      background-color: var(--danger-color);
      color: white;
    }

    .print-btn {
      background-color: var(--secondary-color);
      color: white;
    }

    .login-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
    }

    .confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
    }

    .confirm-content {
      background: white;
      padding: 30px;
      border-radius: var(--border-radius);
      text-align: center;
      max-width: 400px;
      width: 100%;
    }

    .confirm-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .login-content {
      background: white;
      padding: 30px;
      border-radius: var(--border-radius);
      text-align: center;
      max-width: 300px;
      width: 100%;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }

    .login-content h2 {
      margin-bottom: 20px;
      color: var(--primary-color);
      font-size: 1.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .login-content input {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 20px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .login-content input:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    .login-content button {
      padding: 12px 30px;
      font-size: 1rem;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s, background 0.3s;
    }

    .login-content button:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }

    .login-error {
      color: var(--danger-color);
      margin-top: 15px;
      font-weight: bold;
      display: none;
    }

    @media (max-width: 768px) {
      .filters {
        display: none;
      }
      
      .filters-select {
        display: block;
      }
      
      .logout-btn {
        padding: 6px 12px;
        font-size: 0.9rem;
      }

      .logout-btn span {
        display: none;
      }

      .header-controls {
        flex-wrap: wrap;
        justify-content: flex-end;
        top: 10px;
        right: 10px;
        gap: 6px;
      }

      .admin-container {
        padding: 10px;
      }

      .admin-header {
        padding: 1.5rem;
      }

      .order-table {
        font-size: 1.3rem;
      }

      .order-time, .order-item, .order-notes, .action-btn {
        font-size: 0.8rem;
      }
    }

    @media (min-width: 769px) {
      .filters-select {
        display: none;
      }
    }

    @media (max-width: 480px) {
      .filters {
        flex-direction: column;
        align-items: center;
      }

      .filter-btn {
        width: 100%;
        margin-bottom: 5px;
      }

      .orders-grid {
        grid-template-columns: 1fr;
      }

      .admin-header {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="loginModal" class="login-modal">
    <div class="login-content">
      <h2>Acceso Administrador</h2>
      <input type="password" id="adminPinInput" placeholder="🔒 Ingrese su PIN">
      <button id="loginBtn">Ingresar</button>
      <p id="loginError" class="login-error">PIN incorrecto</p>
    </div>
  </div>

  <div id="confirmModal" class="confirm-modal">
    <div class="confirm-content">
      <h2>¿Está seguro de borrar todos los pedidos?</h2>
      <p>Esta acción es irreversible y eliminará todos los pedidos de Firebase.</p>
      <div class="confirm-buttons">
        <button id="confirmDelete" class="action-btn danger">Borrar Todo</button>
        <button id="cancelDelete" class="action-btn secondary">Cancelar</button>
      </div>
    </div>
  </div>
  
  <div class="admin-container">
    <header class="admin-header">
      <h1>Panel de Administración</h1>
      <p>Pedidos en tiempo real</p>
      <div class="header-controls">
        <button id="deleteAllBtn" class="logout-btn">
          <i class="fas fa-trash-alt"></i> <span>Borrar Todo</span>
        </button>
        <button id="soundToggle" class="logout-btn">
          <i class="fas fa-bell"></i> <span>Sonido: ON</span>
        </button>
        <button id="logoutBtn" class="logout-btn">
          <i class="fa fa-sign-out-alt"></i> <span>Cerrar sesión</span>
        </button>
      </div>
    </header>

    <select class="filters-select" id="mobileFilters">
      <option value="all">Todos los pedidos</option>
      <option value="pending">Pendientes</option>
      <option value="completed">Completados</option>
      <option value="cancelled">Cancelados</option>
    </select>

    <div class="filters">
      <button class="filter-btn active" data-filter="all">Todos</button>
      <button class="filter-btn" data-filter="pending">Pendientes</button>
      <button class="filter-btn" data-filter="completed">Completados</button>
      <button class="filter-btn" data-filter="cancelled">Cancelados</button>
    </div>
    
    <div class="orders-grid" id="ordersGrid"></div>
  </div>

  <audio id="orderSound" src="https://github.com/Onixmanager/Prueba2-CamareroDigital/raw/refs/heads/main/notificacion1.mp3" preload="auto"></audio>

  <script type="module">
    const adminPIN = "adminadmin";
    const sessionKey = "adminSession";
    const elements = {
      loginModal: document.getElementById("loginModal"),
      adminPinInput: document.getElementById("adminPinInput"),
      loginBtn: document.getElementById("loginBtn"),
      loginError: document.getElementById("loginError"),
      logoutBtn: document.getElementById("logoutBtn"),
      deleteAllBtn: document.getElementById("deleteAllBtn"),
      confirmModal: document.getElementById("confirmModal"),
      confirmDelete: document.getElementById("confirmDelete"),
      cancelDelete: document.getElementById("cancelDelete"),
      soundToggle: document.getElementById("soundToggle"),
      mobileFilters: document.getElementById("mobileFilters"),
      filterButtons: document.querySelectorAll('.filter-btn'),
      ordersGrid: document.getElementById('ordersGrid')
    };

    // Control de sonido
    let soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
    let lastSoundTime = 0;

    function updateSoundIcon() {
      const icon = elements.soundToggle.querySelector('i');
      const text = elements.soundToggle.querySelector('span');
      icon.className = soundEnabled ? 'fas fa-bell' : 'fas fa-bell-slash';
      text.textContent = soundEnabled ? 'Sonido: ON' : 'Sonido: OFF';
    }

    elements.soundToggle.addEventListener('click', () => {
      soundEnabled = !soundEnabled;
      localStorage.setItem('soundEnabled', soundEnabled);
      updateSoundIcon();
    });
    updateSoundIcon();

    // Autenticación
    function showLoginModal() {
      elements.loginModal.style.display = "flex";
    }

    function hideLoginModal() {
      elements.loginModal.style.display = "none";
    }

    function checkAuth() {
      localStorage.getItem(sessionKey) === "true" ? hideLoginModal() : showLoginModal();
    }

    elements.loginBtn.addEventListener("click", () => {
      if (elements.adminPinInput.value === adminPIN) {
        localStorage.setItem(sessionKey, "true");
        hideLoginModal();
      } else {
        elements.loginError.style.display = "block";
      }
    });

    elements.logoutBtn.addEventListener("click", () => {
      localStorage.removeItem(sessionKey);
      location.reload();
    });

    checkAuth();

    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onChildAdded, onChildChanged, onChildRemoved, update, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzZBL-GfbxbWtPzMHOkSgnfF0UXD7wt4Y",
      authDomain: "pruebacamarero-b7f54.firebaseapp.com",
      databaseURL: "https://pruebacamarero-b7f54-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "pruebacamarero-b7f54",
      storageBucket: "pruebacamarero-b7f54.firebasestorage.app",
      messagingSenderId: "191387429666",
      appId: "1:191387429666:web:ae8472198e543c6de5d37b",
      measurementId: "G-KXDVQLNQW2"
    };

    const appFirebase = initializeApp(firebaseConfig);
    const db = getDatabase(appFirebase);
    const pedidosRef = ref(db, 'pedidos');
    const orderSound = document.getElementById('orderSound');

    // Funciones de pedidos
    async function borrarTodosLosPedidos() {
      try {
        const pedidosSnapshot = await get(pedidosRef);
        const updates = {};
        pedidosSnapshot.forEach((childSnapshot) => {
          updates[childSnapshot.key] = null;
        });
        await update(ref(db), updates);
        elements.ordersGrid.innerHTML = '';
      } catch (error) {
        console.error('Error al borrar pedidos:', error);
      }
    }

    // Manejo de modales
    elements.deleteAllBtn.addEventListener('click', () => {
      elements.confirmModal.style.display = 'flex';
    });

    elements.cancelDelete.addEventListener('click', () => {
      elements.confirmModal.style.display = 'none';
    });

    elements.confirmDelete.addEventListener('click', async () => {
      elements.confirmModal.style.display = 'none';
      await borrarTodosLosPedidos();
    });

    // Funciones de tiempo y creación de tarjetas
    function timeAgo(fecha) {
      const diffMs = Date.now() - new Date(fecha).getTime();
      const diffMin = Math.floor(diffMs / 60000);
      if(diffMin < 1) return "Hace unos instantes";
      return `Hace ${diffMin} minuto${diffMin > 1 ? 's' : ''}`;
    }

    function crearOrderCard(key, data) {
      const status = data.status ? data.status : "pending";
      let statusClass = "status-pending";
      let statusText = "Pendiente";
      if(status === "completed") {
        statusClass = "status-completed";
        statusText = "Completado";
      } else if(status === "cancelled") {
        statusClass = "status-cancelled";
        statusText = "Cancelado";
      }
      
      let itemsHTML = "";
      if (Array.isArray(data.pedido)) {
        data.pedido.forEach(item => {
          const nombre = item.name || "Producto";
          const cantidad = item.qty || 1;
          const precioItem = (item.price * cantidad).toFixed(2);
          
          let detallesMenu = '';
          if(item.menuSelections) {
            detallesMenu = Object.entries(item.menuSelections)
              .map(([seccion, opcion]) => `<div style="font-size:0.8em;color:#666;">${seccion}: ${opcion}</div>`)
              .join('');
          }
          
          let notasItem = '';
          if(item.note) {
            notasItem = `<div style="font-size:0.8em;color:#666;margin-top:4px;">Nota: ${item.note}</div>`;
          }

          itemsHTML += `
            <li class="order-item">
              <div>
                <div style="margin-bottom:4px;">${cantidad}x ${nombre}</div>
                ${detallesMenu}
                ${notasItem}
              </div>
              <span>${precioItem}€</span>
            </li>
          `;
        });
      }
      
      const card = document.createElement('div');
      card.classList.add('order-card');
      card.setAttribute('data-status', status);
      card.setAttribute('data-key', key);
      card.innerHTML = `
        <div class="order-status ${statusClass}">${statusText}</div>
        <h2 class="order-table">${data.mesa || 'Mesa Desconocida'}</h2>
        <div class="order-time">${timeAgo(data.fecha)}</div>
        <ul class="order-items">
          ${itemsHTML}
        </ul>
        ${data.notas ? `<div class="order-notes"><strong>Notas:</strong> ${data.notas}</div>` : ''}
        <div class="order-actions">
          <button class="action-btn complete-btn" data-action="complete">Completar</button>
          <button class="action-btn cancel-btn" data-action="cancel">Cancelar</button>
          <button class="action-btn print-btn" data-action="print">Imprimir</button>
        </div>
      `;
      
      const completeBtn = card.querySelector('[data-action="complete"]');
      const cancelBtn = card.querySelector('[data-action="cancel"]');
      const printBtn = card.querySelector('[data-action="print"]');
      completeBtn.addEventListener('click', () => actualizarEstadoPedido(key, 'completed'));
      cancelBtn.addEventListener('click', () => actualizarEstadoPedido(key, 'cancelled'));
      printBtn.addEventListener('click', () => printReceipt(key, data));
      
      return card;
    }

    function actualizarEstadoPedido(key, nuevoEstado) {
      const pedidoRef = ref(db, 'pedidos/' + key);
      update(pedidoRef, { status: nuevoEstado })
        .then(() => {
          const currentFilter = document.querySelector('.filter-btn.active').dataset.filter;
          const card = document.querySelector(`.order-card[data-key="${key}"]`);
          
          if (currentFilter !== 'all' && currentFilter !== nuevoEstado) {
            card.style.transform = 'scale(0.9)';
            setTimeout(() => card.remove(), 300);
          } else {
            card.setAttribute('data-status', nuevoEstado);
            const statusElement = card.querySelector('.order-status');
            statusElement.className = `order-status status-${nuevoEstado}`;
            statusElement.textContent = nuevoEstado === 'completed' ? 'Completado' : 'Cancelado';
          }
        })
        .catch(error => console.error('Error al actualizar el estado:', error));
    }

    function agregarOActualizarPedido(key, data) {
      const existente = document.querySelector(`.order-card[data-key="${key}"]`);
      const card = crearOrderCard(key, data);
      if (existente) {
        elements.ordersGrid.replaceChild(card, existente);
      } else {
        elements.ordersGrid.appendChild(card);
      }
    }

    function printReceipt(key, data) {
      const printWindow = window.open('', '', 'height=600,width=400');
      printWindow.document.write('<html><head><title>Recibo de Pedido</title>');
      printWindow.document.write('<style>body{font-family: Arial, sans-serif; padding: 20px;} h2{margin-bottom: 10px;} ul{list-style: none; padding: 0;} li{margin-bottom: 5px;}</style>');
      printWindow.document.write('</head><body>');
      printWindow.document.write('<h2>Recibo de Pedido</h2>');
      printWindow.document.write('<p><strong>Mesa:</strong> ' + (data.mesa || 'Mesa Desconocida') + '</p>');
      printWindow.document.write('<p><strong>Fecha:</strong> ' + new Date(data.fecha).toLocaleString() + '</p>');
      printWindow.document.write('<ul>');
      if (Array.isArray(data.pedido)) {
         data.pedido.forEach(item => {
            const cantidad = item.qty || 1;
            const nombre = item.name || 'Producto';
            const precioTotal = (item.price * cantidad).toFixed(2);
            let detalles = '';
            if(item.menuSelections) {
              detalles = Object.entries(item.menuSelections)
                .map(([seccion, opcion]) => `<div>${seccion}: ${opcion}</div>`)
                .join('');
            }
            printWindow.document.write(`
              <li>
                <div>${cantidad} x ${nombre} - ${precioTotal}€</div>
                ${detalles}
                ${item.note ? `<div>Nota: ${item.note}</div>` : ''}
              </li>
            `);
         });
      }
      printWindow.document.write('</ul>');
      if(data.notas) {
          printWindow.document.write('<p><strong>Notas:</strong> ' + data.notas + '</p>');
      }
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    }

    // Listeners de Firebase
    onChildAdded(pedidosRef, (snapshot) => {
      const key = snapshot.key;
      const data = snapshot.val();
      
      if((!data.status || data.status === "pending") && soundEnabled && Date.now() - lastSoundTime > 3000) {
        orderSound.play().catch(error => console.error("Error de sonido:", error));
        lastSoundTime = Date.now();
      }
      
      agregarOActualizarPedido(key, data);
    });

    onChildChanged(pedidosRef, (snapshot) => {
      agregarOActualizarPedido(snapshot.key, snapshot.val());
    });

    onChildRemoved(pedidosRef, (snapshot) => {
      const existente = document.querySelector(`.order-card[data-key="${snapshot.key}"]`);
      if (existente) existente.remove();
    });

    // Filtrado
    function updateFilters(newFilter) {
      elements.filterButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === newFilter);
      });
      elements.mobileFilters.value = newFilter;
      filtrarPedidos(newFilter);
    }

    elements.mobileFilters.addEventListener('change', (e) => updateFilters(e.target.value));
    elements.filterButtons.forEach(btn => {
      btn.addEventListener('click', () => updateFilters(btn.dataset.filter));
    });

    function filtrarPedidos(filtro) {
      document.querySelectorAll('.order-card').forEach(card => {
        card.style.display = (filtro === 'all' || card.dataset.status === filtro) ? 'block' : 'none';
      });
    }
  </script>
</body>
</html>
